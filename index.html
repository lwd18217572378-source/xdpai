<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ²ªç‰Œå°ä¸œ Â· æœºæˆ¿ç›‘æ§ä¸­å¿ƒ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* â•â• æ›¿æ¢ä¸‹é¢ä¸¤è¡Œä¸ºä½ çš„ Supabase é…ç½® â•â•
   SUPABASE_URL  â†’  ä½ çš„é¡¹ç›® URL
   SUPABASE_KEY  â†’  ä½ çš„ anon public key
   æ›¿æ¢å®Œä¿å­˜ï¼Œä¸Šä¼ åˆ° Vercel å³å¯       */

:root{
  --bg:#050d1a;--card:rgba(255,255,255,.04);--border:rgba(255,255,255,.08);
  --cyan:#00d4ff;--green:#00e57a;--gold:#f5c842;--red:#ff4060;--blue:#1a7fff;
  --text:#d8eeff;--muted:#3d6080;--muted2:#5a7a9a;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:'PingFang SC','Microsoft YaHei',Arial,sans-serif}
body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;font-size:13px}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,.12) 0,rgba(0,0,0,.12) 1px,transparent 1px,transparent 3px);pointer-events:none;z-index:9999;opacity:.35}

/* HEADER */
header{background:rgba(0,0,0,.6);border-bottom:1px solid rgba(0,212,255,.2);padding:0 24px;height:54px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;backdrop-filter:blur(10px);position:relative;z-index:100}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,#00d4ff,#1a7fff);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:15px;color:#000;box-shadow:0 0 16px rgba(0,212,255,.4)}
.logo-text{font-family:monospace;font-size:14px;color:#fff;letter-spacing:2px;font-weight:700}
.logo-sub{font-size:10px;color:var(--muted);letter-spacing:2px;margin-top:1px}
.hdr-right{display:flex;align-items:center;gap:18px}
.sync-pill{display:flex;align-items:center;gap:5px;font-size:11px}
.dot{width:6px;height:6px;border-radius:50%;animation:blink 1.5s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.dot-ok{background:var(--green);box-shadow:0 0 6px var(--green)}
.dot-warn{background:var(--gold);box-shadow:0 0 6px var(--gold)}
.dot-err{background:var(--red);box-shadow:0 0 6px var(--red)}
#clk{font-family:monospace;font-size:13px;color:var(--cyan);letter-spacing:2px}
#clk-date{font-size:10px;color:var(--muted);margin-top:1px;text-align:right}

/* TABS */
.tabs{display:flex;border-bottom:1px solid var(--border);background:rgba(0,0,0,.3);flex-shrink:0;padding:0 24px}
.tab{padding:10px 18px;font-size:12px;font-weight:700;cursor:pointer;border-bottom:2px solid transparent;color:var(--muted2);transition:all .2s;white-space:nowrap;letter-spacing:.5px}
.tab:hover{color:var(--text)}
.tab.on{color:var(--cyan);border-bottom-color:var(--cyan)}

/* CONTENT */
.content{flex:1;overflow-y:auto;padding:18px 24px}
.page{display:none}.page.on{display:block}

/* METRICS */
.metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.metric{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;position:relative;overflow:hidden}
.metric::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:2px 2px 0 0}
.mc::after{background:linear-gradient(90deg,var(--blue),var(--cyan))}
.mg::after{background:linear-gradient(90deg,#00aa55,var(--green))}
.mo::after{background:linear-gradient(90deg,#b07000,var(--gold))}
.mr::after{background:linear-gradient(90deg,#c04400,#ff8c42)}
.m-label{font-size:10px;color:var(--muted2);letter-spacing:1px;margin-bottom:8px;text-transform:uppercase}
.m-val{font-family:monospace;font-size:26px;line-height:1}
.m-unit{font-size:11px;margin-left:2px;opacity:.7}
.m-sub{font-size:10px;color:var(--muted);margin-top:5px}

/* ROOMS */
.rooms{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.room{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;transition:border-color .3s}
.room-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.room-id{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:11px;letter-spacing:.5px}
.ri-mh{background:rgba(0,212,255,.1);color:var(--cyan);border:1px solid rgba(0,212,255,.25)}
.ri-jd{background:rgba(0,229,122,.1);color:var(--green);border:1px solid rgba(0,229,122,.25)}
.ri-sj{background:rgba(245,200,66,.1);color:var(--gold);border:1px solid rgba(245,200,66,.25)}
.room-name{font-size:14px;font-weight:700;color:#fff;margin-left:8px;flex:1}
.room-online{font-size:10px;padding:2px 8px;border-radius:20px;background:rgba(0,229,122,.1);color:var(--green);border:1px solid rgba(0,229,122,.25)}
.room-rate{font-family:monospace;font-size:30px;text-align:center;line-height:1;margin-bottom:4px}
.room-rate-label{font-size:10px;color:var(--muted);text-align:center;letter-spacing:1px;margin-bottom:8px}
.bar{height:3px;background:rgba(255,255,255,.06);border-radius:2px;overflow:hidden;margin-bottom:10px}
.bar-fill{height:100%;border-radius:2px;transition:width 1.2s ease}
.room-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.rs{background:rgba(0,0,0,.2);border-radius:8px;padding:8px;text-align:center;border:1px solid rgba(255,255,255,.04)}
.rs-val{font-family:monospace;font-size:16px;color:#fff}
.rs-label{font-size:9px;color:var(--muted);margin-top:3px;letter-spacing:.5px}
.dev-badge{text-align:center;margin-bottom:10px}
.dev-chip{font-size:10px;padding:2px 8px;border-radius:10px}

/* BOTTOM */
.bottom{display:grid;grid-template-columns:200px 1fr;gap:12px}
.price-box{background:var(--card);border:1px solid rgba(255,64,96,.2);border-radius:12px;padding:16px;text-align:center}
.price-label{font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:10px;text-transform:uppercase}
.price-val{font-family:monospace;font-size:24px;color:var(--red);text-shadow:0 0 20px rgba(255,64,96,.4);letter-spacing:1px}
.price-badge{margin-top:10px;font-size:10px;background:rgba(0,229,122,.1);color:var(--green);border:1px solid rgba(0,229,122,.25);border-radius:20px;padding:4px 12px;display:inline-block}
.log-box{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.log-head{padding:9px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.2)}
.log-title{font-size:11px;font-weight:700;letter-spacing:.5px}
.live-badge{font-size:9px;color:var(--green);display:flex;align-items:center;gap:4px;font-weight:700}
.live-dot{width:5px;height:5px;border-radius:50%;background:var(--green);animation:blink 1.5s infinite}
.log-body{height:130px;overflow-y:auto}
.log-row{display:flex;align-items:center;gap:8px;padding:4px 12px;border-bottom:1px solid rgba(255,255,255,.02);font-size:11px}
.log-t{color:var(--muted);font-family:monospace;min-width:58px}
.log-room{min-width:58px;font-weight:700;font-size:10px}
.log-dev{color:var(--muted);min-width:50px;font-size:10px}
.log-action{min-width:28px}
.log-price{margin-left:auto;font-family:monospace;color:#fff}
.log-delta{font-family:monospace;min-width:46px;text-align:right;font-size:10px}

/* QUERY */
.q-layout{display:grid;grid-template-columns:300px 1fr;gap:14px}
.q-col{display:flex;flex-direction:column;gap:12px}
.panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px}
.panel-title{font-size:11px;font-weight:700;color:var(--cyan);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:7px}
.panel-title::before{content:'';width:3px;height:12px;background:var(--cyan);border-radius:2px;flex-shrink:0}
textarea{width:100%;background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:12px;resize:vertical;outline:none;line-height:1.9;font-family:monospace}
textarea:focus{border-color:rgba(0,212,255,.35)}
textarea::placeholder{color:var(--muted)}
.btn{padding:9px 0;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700;width:100%;transition:all .2s;letter-spacing:.5px}
.btn-gold{background:linear-gradient(90deg,#b07000,var(--gold));color:#1a0f00}
.btn-gold:hover{opacity:.9}
.btn-ghost{background:rgba(255,255,255,.05);color:var(--muted2);border:1px solid var(--border)}
.btn-ghost:hover{color:var(--text)}
.btn-cyan{background:linear-gradient(90deg,#005580,var(--cyan));color:#000}

/* RESULT */
.r-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.r-card{text-align:center;padding:14px 8px;border-radius:10px}
.r-v{font-family:monospace;font-size:26px;line-height:1}
.r-l{font-size:10px;color:var(--muted);margin-top:5px;letter-spacing:.5px}
.tags{display:flex;flex-wrap:wrap;gap:8px}
.tag{background:rgba(0,229,122,.08);border:1px solid rgba(0,229,122,.25);border-radius:8px;padding:7px 14px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .2s}
.tag:hover{background:rgba(0,229,122,.18);transform:translateY(-2px);box-shadow:0 4px 14px rgba(0,229,122,.2)}
.tw-name{font-size:12px;font-weight:900;color:#fff}
.tw-num{font-size:11px;color:var(--green);font-family:monospace;letter-spacing:.5px}
.empty-hint{display:flex;align-items:center;justify-content:center;height:280px;color:var(--muted);flex-direction:column;gap:8px}

/* IMPORT */
.import-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.msg{font-size:11px;margin-top:8px;min-height:16px;line-height:1.6}
.msg.ok{color:var(--green)}.msg.err{color:var(--red)}.msg.info{color:var(--muted2)}
.chip{background:rgba(0,212,255,.06);border:1px solid rgba(0,212,255,.14);border-radius:6px;padding:10px 12px;font-size:11px;color:#7ab3f0;line-height:1.9;margin-top:12px}
.pb{height:2px;background:rgba(255,255,255,.06);border-radius:1px;overflow:hidden;margin-top:10px}
.pb-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--cyan));transition:width .6s ease;width:0}
.file-zone{border:1px dashed rgba(0,212,255,.2);border-radius:8px;padding:18px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:12px}
.file-zone:hover{border-color:rgba(0,212,255,.4);background:rgba(0,212,255,.03)}
.pair-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;max-height:220px;overflow-y:auto;margin-bottom:12px}
.pair-item{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px}
.pair-thumb{width:36px;height:36px;border-radius:4px;object-fit:cover;border:1px solid rgba(0,212,255,.15);flex-shrink:0}
.pair-input{width:100%;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:4px;padding:3px 6px;color:#fff;font-size:11px;font-family:monospace;outline:none}

/* SETTINGS */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.field-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.field-label{font-size:12px;color:var(--muted2)}
.field-input{width:120px;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:6px;padding:5px 10px;color:#fff;font-size:12px;font-family:monospace;text-align:right;outline:none}
.field-input:focus{border-color:rgba(0,212,255,.35)}
.save-btn{margin-top:14px;width:100%;padding:10px 0;border:none;border-radius:8px;cursor:pointer;background:linear-gradient(90deg,var(--blue),var(--cyan));color:#000;font-size:12px;font-weight:700;letter-spacing:1px;transition:opacity .2s}
.save-btn:hover{opacity:.85}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:500;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.overlay.on{display:flex}
.modal{background:#06101f;border:1px solid rgba(0,212,255,.2);border-radius:14px;width:520px;max-width:95vw;max-height:88vh;overflow-y:auto;box-shadow:0 0 60px rgba(0,212,255,.12)}
.modal-head{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start}
.modal-body{padding:18px 22px 22px}
.modal-close{background:none;border:none;color:var(--muted2);font-size:18px;cursor:pointer}
.modal-close:hover{color:#fff}
.bid-badge{display:inline-flex;background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);border-radius:5px;padding:3px 9px;font-size:11px;font-family:monospace;color:var(--cyan);margin-top:6px}
.won-badge{display:inline-flex;background:rgba(0,229,122,.12);border:1px solid rgba(0,229,122,.25);border-radius:20px;padding:3px 10px;font-size:11px;font-weight:700;color:var(--green);margin-left:8px;margin-top:6px}
.evidence-title{font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;margin-top:16px}
.evidence-img{width:100%;border-radius:8px;border:1px solid rgba(0,212,255,.15);max-height:360px;object-fit:contain;background:rgba(0,0,0,.3)}
.no-evidence{border:1px dashed var(--border);border-radius:8px;padding:28px;text-align:center;color:var(--muted);font-size:12px;line-height:2}

/* LOADING */
#loading{position:fixed;inset:0;background:#050d1a;z-index:2000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px}
#loading .spin{font-size:36px;animation:spin 1.5s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:2px}

/* INFO ROW */
.info-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:12px}
.ir-l{color:var(--muted2)}.ir-r{font-weight:700;color:#fff}

/* â”€â”€ LOGIN â”€â”€ */
#login-screen{
  position:fixed;inset:0;z-index:10000;
  background:#050d1a;
  display:flex;align-items:center;justify-content:center;
}
#login-screen::before{
  content:'';position:absolute;inset:0;
  background:repeating-linear-gradient(0deg,rgba(0,0,0,.12) 0,rgba(0,0,0,.12) 1px,transparent 1px,transparent 3px);
  opacity:.35;pointer-events:none;
}
.login-box{
  position:relative;z-index:1;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(0,212,255,.2);
  border-radius:16px;
  padding:40px 36px;
  width:360px;
  box-shadow:0 0 60px rgba(0,212,255,.1);
  text-align:center;
}
.login-icon{width:56px;height:56px;background:linear-gradient(135deg,#00d4ff,#1a7fff);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px;color:#000;margin:0 auto 16px;box-shadow:0 0 24px rgba(0,212,255,.4)}
.login-title{font-family:monospace;font-size:16px;color:#fff;letter-spacing:2px;font-weight:700;margin-bottom:4px}
.login-sub{font-size:11px;color:#3d6080;letter-spacing:1px;margin-bottom:28px}
.login-input-wrap{position:relative;margin-bottom:12px}
.login-input{
  width:100%;background:rgba(0,0,0,.4);
  border:1px solid rgba(255,255,255,.1);
  border-radius:8px;padding:12px 44px 12px 14px;
  color:#fff;font-size:14px;outline:none;letter-spacing:2px;
  transition:border-color .2s;
}
.login-input:focus{border-color:rgba(0,212,255,.4)}
.login-input::placeholder{letter-spacing:.5px;color:#3d6080}
.toggle-pw{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:#3d6080;cursor:pointer;font-size:14px;padding:2px}
.toggle-pw:hover{color:#fff}
.login-btn{
  width:100%;padding:12px 0;border:none;border-radius:8px;
  background:linear-gradient(90deg,#005580,#00d4ff);
  color:#000;font-size:13px;font-weight:700;cursor:pointer;
  letter-spacing:1px;transition:opacity .2s;margin-top:4px;
}
.login-btn:hover{opacity:.88}
.login-err{font-size:12px;color:#ff4060;margin-top:10px;min-height:18px;letter-spacing:.5px}
.login-footer{font-size:10px;color:#3d6080;margin-top:20px;line-height:1.8}
</style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€ -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-icon">ä¸œ</div>
    <div class="login-title">æ²ªç‰Œå°ä¸œ Â· ç›‘æ§ä¸­å¿ƒ</div>
    <div class="login-sub">INTERNAL SYSTEM Â· å†…éƒ¨ä¸“ç”¨</div>
    <div class="login-input-wrap">
      <input class="login-input" id="pw-input" type="password" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç " onkeydown="if(event.key==='Enter')doLogin()">
      <button class="toggle-pw" onclick="togglePw()">ğŸ‘</button>
    </div>
    <button class="login-btn" onclick="doLogin()">è¿› å…¥ ç³» ç»Ÿ</button>
    <div class="login-err" id="login-err"></div>
    <div class="login-footer">ä»…é™å†…éƒ¨äººå‘˜ä½¿ç”¨<br>æœªç»æˆæƒè®¿é—®å°†è¢«è®°å½•</div>
  </div>
</div>

<div id="loading"
  <div class="spin">ğŸš—</div>
  <div style="font-family:monospace;color:#00d4ff;font-size:13px;letter-spacing:2px">æ²ªç‰Œå°ä¸œ Â· ç›‘æ§ä¸­å¿ƒ</div>
  <div style="color:#3d6080;font-size:11px">æ­£åœ¨ä»äº‘ç«¯åŒæ­¥æ•°æ®...</div>
</div>

<header>
  <div class="logo">
    <div class="logo-icon">ä¸œ</div>
    <div>
      <div class="logo-text">æ²ªç‰Œå°ä¸œ Â· æœºæˆ¿ç›‘æ§ä¸­å¿ƒ</div>
      <div class="logo-sub">SHANGHAI LICENSE PLATE MONITORING SYSTEM</div>
    </div>
  </div>
  <div class="hdr-right">
    <div class="sync-pill">
      <div class="dot dot-warn" id="sync-dot"></div>
      <span id="sync-text" style="color:var(--gold);font-size:11px">è¿æ¥ä¸­...</span>
    </div>
    <div style="text-align:right">
      <div id="clk">â€”</div>
      <div id="clk-date">â€”</div>
    </div>
  </div>
</header>

<div class="tabs">
  <div class="tab on" onclick="go('dashboard',this)">ğŸ“Š å®æ—¶ç›‘æ§</div>
  <div class="tab" onclick="go('query',this)">ğŸ” ä¸­æ ‡æŸ¥è¯¢</div>
  <div class="tab" onclick="go('import',this)">ğŸ“‹ åå• & æˆªå›¾</div>
  <div class="tab" onclick="go('settings',this)">âš™ï¸ æ•°æ®è®¾ç½®</div>
</div>

<div class="content">

<!-- â•â•â• DASHBOARD â•â•â• -->
<div class="page on" id="page-dashboard">
  <div class="metrics">
    <div class="metric mc">
      <div class="m-label">æœ¬æœˆé¢åº¦æ•°</div>
      <div class="m-val" style="color:var(--cyan);text-shadow:0 0 20px rgba(0,212,255,.5)"><span id="d-quota">3,793</span><span class="m-unit">å¼ </span></div>
      <div class="m-sub">2æœˆå…¨å¸‚æŠ•æ”¾é¢åº¦</div>
    </div>
    <div class="metric mg">
      <div class="m-label">æœåŠ¡äººæ•°</div>
      <div class="m-val" style="color:var(--green);text-shadow:0 0 20px rgba(0,229,122,.5)"><span id="d-serve">815</span><span class="m-unit">äºº</span></div>
      <div class="m-sub">ä¸‰æœºæˆ¿å§”æ‰˜åˆè®¡</div>
    </div>
    <div class="metric mo">
      <div class="m-label">å¹³å‡ä¸­æ ‡ç‡</div>
      <div class="m-val" style="color:var(--gold);text-shadow:0 0 20px rgba(245,200,66,.5)"><span id="d-rate">41.84</span><span class="m-unit">%</span></div>
      <div class="m-sub">è¡Œä¸šå‡å€¼çº¦ 5%</div>
    </div>
    <div class="metric mr">
      <div class="m-label">ä¸­æ ‡äººæ•°</div>
      <div class="m-val" style="color:#ff8c42;text-shadow:0 0 20px rgba(255,140,66,.5)"><span id="d-won">341</span><span class="m-unit">äºº</span></div>
      <div class="m-sub">æœ¬æœŸæˆåŠŸä¸­æ ‡</div>
    </div>
  </div>

  <div class="rooms">
    <div class="room" style="border-color:rgba(0,212,255,.2)">
      <div class="room-head">
        <div class="room-id ri-mh">MH</div>
        <span class="room-name">é—µè¡Œæœºæˆ¿</span>
        <div class="room-online">è¿è¡Œä¸­</div>
      </div>
      <div class="room-rate" style="color:var(--cyan);text-shadow:0 0 20px rgba(0,212,255,.4)"><span id="r-mh-rate">41.79</span><small style="font-size:14px">%</small></div>
      <div class="room-rate-label">å½“æœˆä¸­æ ‡ç‡</div>
      <div class="bar"><div class="bar-fill" id="rb-mh" style="background:linear-gradient(90deg,var(--blue),var(--cyan));width:0"></div></div>
      <div class="dev-badge"><span class="dev-chip" style="background:rgba(0,212,255,.08);color:var(--cyan);border:1px solid rgba(0,212,255,.2)" id="r-mh-dev">42 è®¾å¤‡åœ¨çº¿</span></div>
      <div class="room-stats">
        <div class="rs"><div class="rs-val" id="r-mh-serve">280</div><div class="rs-label">æœåŠ¡äººæ•°</div></div>
        <div class="rs"><div class="rs-val" id="r-mh-won">117</div><div class="rs-label">ä¸­æ ‡äººæ•°</div></div>
      </div>
    </div>
    <div class="room" style="border-color:rgba(0,229,122,.2)">
      <div class="room-head">
        <div class="room-id ri-jd">JD</div>
        <span class="room-name">å˜‰å®šæœºæˆ¿</span>
        <div class="room-online">è¿è¡Œä¸­</div>
      </div>
      <div class="room-rate" style="color:var(--green);text-shadow:0 0 20px rgba(0,229,122,.4)"><span id="r-jd-rate">41.91</span><small style="font-size:14px">%</small></div>
      <div class="room-rate-label">å½“æœˆä¸­æ ‡ç‡</div>
      <div class="bar"><div class="bar-fill" id="rb-jd" style="background:linear-gradient(90deg,#00aa55,var(--green));width:0"></div></div>
      <div class="dev-badge"><span class="dev-chip" style="background:rgba(0,229,122,.08);color:var(--green);border:1px solid rgba(0,229,122,.2)" id="r-jd-dev">38 è®¾å¤‡åœ¨çº¿</span></div>
      <div class="room-stats">
        <div class="rs"><div class="rs-val" id="r-jd-serve">272</div><div class="rs-label">æœåŠ¡äººæ•°</div></div>
        <div class="rs"><div class="rs-val" id="r-jd-won">114</div><div class="rs-label">ä¸­æ ‡äººæ•°</div></div>
      </div>
    </div>
    <div class="room" style="border-color:rgba(245,200,66,.2)">
      <div class="room-head">
        <div class="room-id ri-sj">SJ</div>
        <span class="room-name">æ¾æ±Ÿæœºæˆ¿</span>
        <div class="room-online">è¿è¡Œä¸­</div>
      </div>
      <div class="room-rate" style="color:var(--gold);text-shadow:0 0 20px rgba(245,200,66,.4)"><span id="r-sj-rate">41.83</span><small style="font-size:14px">%</small></div>
      <div class="room-rate-label">å½“æœˆä¸­æ ‡ç‡</div>
      <div class="bar"><div class="bar-fill" id="rb-sj" style="background:linear-gradient(90deg,#b07000,var(--gold));width:0"></div></div>
      <div class="dev-badge"><span class="dev-chip" style="background:rgba(245,200,66,.08);color:var(--gold);border:1px solid rgba(245,200,66,.2)" id="r-sj-dev">35 è®¾å¤‡åœ¨çº¿</span></div>
      <div class="room-stats">
        <div class="rs"><div class="rs-val" id="r-sj-serve">263</div><div class="rs-label">æœåŠ¡äººæ•°</div></div>
        <div class="rs"><div class="rs-val" id="r-sj-won">110</div><div class="rs-label">ä¸­æ ‡äººæ•°</div></div>
      </div>
    </div>
  </div>

  <div class="bottom">
    <div class="price-box">
      <div class="price-label">æœ¬æœˆæˆäº¤ä»·</div>
      <div class="price-val" id="d-price">Â¥94,400</div>
      <div class="price-badge">â— å·²æˆäº¤</div>
    </div>
    <div class="log-box">
      <div class="log-head">
        <span class="log-title">å®æ—¶ç«ä»·æ—¥å¿—ï¼ˆæ¨¡æ‹Ÿå±•ç¤ºï¼‰</span>
        <span class="live-badge"><span class="live-dot"></span>LIVE</span>
      </div>
      <div class="log-body" id="log-body"></div>
    </div>
  </div>
</div>

<!-- â•â•â• QUERY â•â•â• -->
<div class="page" id="page-query">
  <div class="q-layout">
    <div class="q-col">
      <div class="panel">
        <div class="panel-title">å§”æ‰˜æŠ•æ ‡å·è¾“å…¥</div>
        <textarea id="q-input" rows="10" placeholder="æ”¯æŒã€Œå§“å + æŠ•æ ‡å·ã€æ ¼å¼&#10;æ¯è¡Œä¸€ä¸ª&#10;&#10;ç¤ºä¾‹ï¼š&#10;å¼ ä¼Ÿ  59312345&#10;æå¨œ  59456789&#10;&#10;ä¹Ÿæ”¯æŒçº¯æŠ•æ ‡å·"></textarea>
        <button class="btn btn-gold" style="margin-top:8px" onclick="doQuery()">ğŸ” ç«‹å³æŸ¥è¯¢ä¸­æ ‡ç»“æœ</button>
        <button class="btn btn-ghost" style="margin-top:6px" onclick="clearQ()">æ¸…ç©º</button>
      </div>
      <div class="panel">
        <div class="panel-title">å½“å‰çŠ¶æ€</div>
        <div class="info-row"><span class="ir-l">åå•çŠ¶æ€</span><span class="ir-r" id="qs-list" style="color:var(--muted)">æœªåŠ è½½</span></div>
        <div class="info-row"><span class="ir-l">æˆªå›¾åº“</span><span class="ir-r" id="qs-img" style="color:var(--muted)">æœªåŠ è½½</span></div>
        <div style="font-size:10px;color:var(--muted);margin-top:8px;line-height:1.8">ç‚¹å‡»ä¸­æ ‡æ ‡ç­¾å¯æŸ¥çœ‹å®¢æˆ·å‡­è¯æˆªå›¾ ğŸ“·</div>
      </div>
    </div>
    <div id="q-result">
      <div class="panel empty-hint">
        <div style="font-size:36px;opacity:.2">ğŸ”</div>
        <div style="font-size:12px">åœ¨å·¦ä¾§è¾“å…¥æŠ•æ ‡å·åç‚¹å‡»æŸ¥è¯¢</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• IMPORT â•â•â• -->
<div class="page" id="page-import">
  <div class="import-grid">
    <div class="panel">
      <div class="panel-title">ğŸ”„ è‡ªåŠ¨åŒæ­¥å®˜æ–¹åå•</div>
      <p style="font-size:11px;color:var(--muted2);line-height:1.8;margin-bottom:12px">è‡ªåŠ¨æ‹‰å–æœ¬æœˆæˆäº¤æŠ•æ ‡å·ï¼ŒåŒæ­¥äº‘ç«¯å<strong style="color:var(--cyan)">æ‰€æœ‰è®¾å¤‡ç«‹å³å¯ç”¨</strong>ï¼Œå½“æœˆæ— éœ€é‡å¤æ“ä½œã€‚</p>
      <button class="btn btn-cyan" onclick="syncList()">ç«‹å³åŒæ­¥æœ¬æœˆåå•</button>
      <div class="pb"><div class="pb-fill" id="sync-pb"></div></div>
      <div class="msg" id="sync-msg"></div>
      <div class="chip">ğŸ“Œ æ•°æ®æºï¼šchepai.alltobid.com<br>è·¯å¾„ï¼šä¸ªäººå®¢è½¦é¢åº¦ â†’ æˆäº¤æ¸…å•<br><strong style="color:var(--cyan)">äº‘ç«¯å­˜å‚¨ = æ‰€æœ‰è®¾å¤‡æ‰“å¼€è‡ªåŠ¨åŒæ­¥</strong></div>
    </div>
    <div class="panel">
      <div class="panel-title">ğŸ“‹ æ‰‹åŠ¨å¯¼å…¥ï¼ˆå¤‡ç”¨ï¼‰</div>
      <p style="font-size:11px;color:var(--muted2);line-height:1.8;margin-bottom:12px">ä»å®˜ç½‘å¤åˆ¶æœ¬æœŸæˆäº¤åå•ç²˜è´´è‡³æ­¤ï¼Œä¿å­˜åäº‘ç«¯åŒæ­¥ã€‚</p>
      <textarea id="win-input" rows="6" placeholder="ç›´æ¥å¤åˆ¶å®˜ç½‘æ•´å¼ æˆäº¤è¡¨æ ¼ç²˜è´´åˆ°è¿™é‡Œ&#10;æ ¼å¼è‡ªåŠ¨è¯†åˆ«ï¼Œå¸¦åºå·çš„è¡¨æ ¼ä¹Ÿæ²¡é—®é¢˜"></textarea>
      <button class="btn btn-gold" style="margin-top:8px" onclick="importManual()">å¯¼å…¥å¹¶äº‘ç«¯ä¿å­˜</button>
      <div class="msg" id="manual-msg"></div>
    </div>

    <div class="panel" style="grid-column:1/-1">
      <div class="panel-title">ğŸ“· ä¸­æ ‡å‡­è¯æˆªå›¾åº“</div>
      <p style="font-size:11px;color:var(--muted2);line-height:1.8;margin-bottom:12px">
        æˆªå›¾æ–‡ä»¶å»ºè®®å‘½åä¸º <strong style="color:var(--cyan)">æŠ•æ ‡å·.jpg</strong>ï¼ˆå¦‚ 59200020.jpgï¼‰ï¼Œä¸Šä¼ åè‡ªåŠ¨åŒ¹é…ã€‚
        æˆªå›¾ä¿å­˜äº‘ç«¯ï¼Œä»»ä½•è®¾å¤‡ç‚¹å‡»ä¸­æ ‡æ ‡ç­¾å‡å¯æŸ¥çœ‹å‡­è¯ã€‚
      </p>
      <div class="file-zone" onclick="document.getElementById('img-files').click()">
        <input type="file" id="img-files" multiple accept="image/*" style="display:none" onchange="loadImgs(this)">
        <div style="font-size:28px;margin-bottom:8px">ğŸ–¼ï¸</div>
        <div style="font-size:12px;color:var(--muted2);line-height:1.7">ç‚¹å‡»é€‰æ‹©æˆªå›¾ï¼ˆæ”¯æŒå¤šé€‰ï¼‰<br>å»ºè®®å‘½åï¼šæŠ•æ ‡å·.jpg / æŠ•æ ‡å·.png</div>
        <div style="margin-top:8px;font-size:10px;background:rgba(0,229,122,.1);color:var(--green);padding:2px 10px;border-radius:20px;display:inline-block" id="img-count">æˆªå›¾åº“ï¼š<span id="img-cnt">0</span> å¼ </div>
      </div>
      <div id="pair-area" style="display:none">
        <div style="font-size:11px;color:var(--muted2);margin-bottom:10px">å·²é€‰ <span id="pending-cnt">0</span> å¼  Â· ç¡®è®¤æŠ•æ ‡å·é…å¯¹ï¼ˆæ–‡ä»¶ååŒ¹é…å·²è‡ªåŠ¨å¡«å…¥ï¼‰</div>
        <div class="pair-grid" id="pair-list"></div>
        <button class="btn btn-gold" style="max-width:180px" onclick="saveImgs()">ä¸Šä¼ åˆ°äº‘ç«¯</button>
        <div class="msg" id="img-msg"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• SETTINGS â•â•â• -->
<div class="page" id="page-settings">
  <div class="settings-grid">
    <div class="panel">
      <div class="panel-title">å…¨å±€æ•°æ®</div>
      <div class="field-row"><span class="field-label">æœ¬æœˆé¢åº¦æ•°ï¼ˆå¼ ï¼‰</span><input class="field-input" id="s-quota" value="3793"></div>
      <div class="field-row"><span class="field-label">æœåŠ¡äººæ•°ï¼ˆäººï¼‰</span><input class="field-input" id="s-serve" value="815"></div>
      <div class="field-row"><span class="field-label">å¹³å‡ä¸­æ ‡ç‡ï¼ˆ%ï¼‰</span><input class="field-input" id="s-rate" value="41.84"></div>
      <div class="field-row"><span class="field-label">ä¸­æ ‡äººæ•°ï¼ˆäººï¼‰</span><input class="field-input" id="s-won" value="341"></div>
      <div class="field-row"><span class="field-label">æœ¬æœˆæˆäº¤ä»·ï¼ˆå…ƒï¼‰</span><input class="field-input" id="s-price" value="94400"></div>
      <button class="save-btn" onclick="saveSettings()">ä¿å­˜å¹¶åŒæ­¥æ‰€æœ‰è®¾å¤‡</button>
    </div>
    <div class="panel">
      <div class="panel-title">æœºæˆ¿æ•°æ®</div>
      <div style="font-size:10px;color:var(--cyan);letter-spacing:1px;margin-bottom:6px;margin-top:4px">é—µè¡Œæœºæˆ¿</div>
      <div class="field-row"><span class="field-label">åœ¨çº¿è®¾å¤‡æ•°</span><input class="field-input" id="s-mh-dev" value="42"></div>
      <div class="field-row"><span class="field-label">æœåŠ¡äººæ•°</span><input class="field-input" id="s-mh-serve" value="280"></div>
      <div class="field-row"><span class="field-label">ä¸­æ ‡äººæ•°</span><input class="field-input" id="s-mh-won" value="117"></div>
      <div style="font-size:10px;color:var(--green);letter-spacing:1px;margin-bottom:6px;margin-top:10px">å˜‰å®šæœºæˆ¿</div>
      <div class="field-row"><span class="field-label">åœ¨çº¿è®¾å¤‡æ•°</span><input class="field-input" id="s-jd-dev" value="38"></div>
      <div class="field-row"><span class="field-label">æœåŠ¡äººæ•°</span><input class="field-input" id="s-jd-serve" value="272"></div>
      <div class="field-row"><span class="field-label">ä¸­æ ‡äººæ•°</span><input class="field-input" id="s-jd-won" value="114"></div>
      <div style="font-size:10px;color:var(--gold);letter-spacing:1px;margin-bottom:6px;margin-top:10px">æ¾æ±Ÿæœºæˆ¿</div>
      <div class="field-row"><span class="field-label">åœ¨çº¿è®¾å¤‡æ•°</span><input class="field-input" id="s-sj-dev" value="35"></div>
      <div class="field-row"><span class="field-label">æœåŠ¡äººæ•°</span><input class="field-input" id="s-sj-serve" value="263"></div>
      <div class="field-row"><span class="field-label">ä¸­æ ‡äººæ•°</span><input class="field-input" id="s-sj-won" value="110"></div>
      <button class="save-btn" onclick="saveSettings()">ä¿å­˜å¹¶åŒæ­¥æ‰€æœ‰è®¾å¤‡</button>
    </div>
  </div>
</div>

</div><!-- /content -->

<!-- MODAL -->
<div class="overlay" id="modal" onclick="if(event.target===this)this.classList.remove('on')">
  <div class="modal">
    <div class="modal-head">
      <div>
        <div style="font-size:18px;font-weight:900;color:#fff" id="m-name">â€”</div>
        <div class="bid-badge" id="m-bid">æŠ•æ ‡å· â€”</div>
        <div class="won-badge">âœ“ æœ¬æœŸä¸­æ ‡</div>
      </div>
      <button class="modal-close" onclick="document.getElementById('modal').classList.remove('on')">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="background:rgba(0,0,0,.2);border-radius:6px;padding:10px 12px;border:1px solid rgba(255,255,255,.04)">
        <div style="font-size:10px;color:var(--muted);margin-bottom:4px;letter-spacing:.5px">ä¸­æ ‡ç‡åŒºé—´</div>
        <div style="font-size:13px;font-weight:700;color:#fff">41.79% ~ 41.91%</div>
      </div>
      <div class="evidence-title">ä¸­æ ‡å‡­è¯æˆªå›¾</div>
      <div id="m-evidence">
        <div class="no-evidence"><div style="font-size:24px;margin-bottom:8px;opacity:.3">ğŸ“·</div>æš‚æ— æˆªå›¾</div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš ï¸  æ›¿æ¢è¿™é‡Œä¸¤ä¸ªå€¼ä¸ºä½ çš„ Supabase é…ç½®
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'YOUR_SUPABASE_URL';
const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let winSet = new Set();
let imgIndex = {};        // bid -> storage path
const WIN_URL = 'https://chepai.alltobid.com/canpai.web/contents/34/178.html';
const PROXIES = [
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://corsproxy.io/?${encodeURIComponent(u)}`,
];

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', ()=>{ checkAuth(); });

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clockStart(){
  const tick=()=>{
    const n=new Date(), p=x=>String(x).padStart(2,'0');
    document.getElementById('clk').textContent=`${p(n.getHours())}:${p(n.getMinutes())}:${p(n.getSeconds())}`;
    document.getElementById('clk-date').textContent=n.toLocaleDateString('zh-CN',{year:'numeric',month:'long',day:'numeric',weekday:'long'});
  };
  tick(); setInterval(tick,1000);
}

// â”€â”€ SUPABASE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dbGet(key){
  const {data}=await sb.from('config').select('value').eq('key',key).single();
  return data?JSON.parse(data.value):null;
}
async function dbSet(key,val){
  await sb.from('config').upsert({key,value:JSON.stringify(val)},{onConflict:'key'});
}

// â”€â”€ LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats(){
  const s=await dbGet('stats');
  if(s) applyStats(s);
  else applyStats({quota:3793,serve:815,rate:'41.84',won:341,price:94400,mh:{dev:42,serve:280,won:117},jd:{dev:38,serve:272,won:114},sj:{dev:35,serve:263,won:110}});
}

async function loadWinList(){
  const month=nowMonth(), saved=await dbGet('winmonth');
  if(saved===month){
    const list=await dbGet('winlist');
    if(list){winSet=new Set(list);updateListStatus();}
  }
}

async function loadImgIndex(){
  const idx=await dbGet('imgindex');
  if(idx){imgIndex=idx;updateImgStatus();}
}

// â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyStats(s){
  const g=(id,fallback)=>{const e=document.getElementById(id);return e?e.value:fallback;};
  if(!s){
    s={
      quota:parseFloat(g('s-quota',3793)),serve:parseFloat(g('s-serve',815)),
      rate:g('s-rate','41.84'),won:parseFloat(g('s-won',341)),price:parseFloat(g('s-price',94400)),
      mh:{dev:parseFloat(g('s-mh-dev',42)),serve:parseFloat(g('s-mh-serve',280)),won:parseFloat(g('s-mh-won',117))},
      jd:{dev:parseFloat(g('s-jd-dev',38)),serve:parseFloat(g('s-jd-serve',272)),won:parseFloat(g('s-jd-won',114))},
      sj:{dev:parseFloat(g('s-sj-dev',35)),serve:parseFloat(g('s-sj-serve',263)),won:parseFloat(g('s-sj-won',110))},
    };
  }
  // Populate form
  ['quota','serve','rate','won','price'].forEach(k=>{const e=document.getElementById('s-'+k);if(e)e.value=s[k];});
  ['mh','jd','sj'].forEach(r=>{['dev','serve','won'].forEach(f=>{const e=document.getElementById(`s-${r}-${f}`);if(e&&s[r])e.value=s[r][f];});});
  // Update display
  setText('d-quota',(+s.quota||0).toLocaleString());
  setText('d-serve',(+s.serve||0).toLocaleString());
  setText('d-rate',s.rate||'41.84');
  setText('d-won',(+s.won||0).toLocaleString());
  document.getElementById('d-price').textContent='Â¥'+(+s.price||0).toLocaleString();
  updateRoom('mh',s.mh||{});
  updateRoom('jd',s.jd||{});
  updateRoom('sj',s.sj||{});
}

function updateRoom(id,r){
  const rate=r.serve>0?(r.won/r.serve*100).toFixed(2):'0.00';
  setText(`r-${id}-rate`,rate);
  setText(`r-${id}-serve`,r.serve||0);
  setText(`r-${id}-won`,r.won||0);
  setText(`r-${id}-dev`,(r.dev||0)+' è®¾å¤‡åœ¨çº¿');
  setTimeout(()=>{
    const el=document.getElementById(`rb-${id}`);
    if(el)el.style.width=Math.min(parseFloat(rate),100)+'%';
  },200);
}

async function saveSettings(){
  const g=id=>{const e=document.getElementById(id);return e?e.value:'';};
  const s={
    quota:+g('s-quota'),serve:+g('s-serve'),rate:g('s-rate'),won:+g('s-won'),price:+g('s-price'),
    mh:{dev:+g('s-mh-dev'),serve:+g('s-mh-serve'),won:+g('s-mh-won')},
    jd:{dev:+g('s-jd-dev'),serve:+g('s-jd-serve'),won:+g('s-jd-won')},
    sj:{dev:+g('s-sj-dev'),serve:+g('s-sj-serve'),won:+g('s-sj-won')},
  };
  await dbSet('stats',s);
  applyStats(s);
  alert('âœ… æ•°æ®å·²ä¿å­˜ï¼Œæ‰€æœ‰è®¾å¤‡å®æ—¶åŒæ­¥ï¼');
}

// â”€â”€ SYNC WIN LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function syncList(){
  setSyncDot('warn','åŒæ­¥ä¸­...');
  setMsg('sync-msg','æ­£åœ¨è¿æ¥å®˜æ–¹åå•...','info');
  setPb('sync-pb',10);
  let found=null;
  for(let i=0;i<PROXIES.length&&!found;i++){
    try{
      setPb('sync-pb',20+i*30);
      const res=await fetch(PROXIES[i](WIN_URL),{signal:AbortSignal.timeout(9000)});
      if(res.ok){const t=await res.text();const s=extractBids(t);if(s.size>50){found=s;break;}}
    }catch(e){}
  }
  setPb('sync-pb',90);
  if(found){
    const arr=[...found];
    winSet=found;
    await dbSet('winlist',arr);
    await dbSet('winmonth',nowMonth());
    setPb('sync-pb',100);
    setSyncDot('ok',`åå•å·²å°±ç»ª ${arr.length.toLocaleString()} æ¡`);
    setMsg('sync-msg',`âœ… åŒæ­¥æˆåŠŸï¼æœ¬æœŸå…± ${arr.length.toLocaleString()} ä¸ªæˆäº¤æŠ•æ ‡å·ï¼Œå·²åŒæ­¥äº‘ç«¯`,'ok');
    updateListStatus();
  }else{
    setPb('sync-pb',100);
    setSyncDot('err','è‡ªåŠ¨åŒæ­¥å¤±è´¥');
    setMsg('sync-msg','âš ï¸ ç½‘ç»œé™åˆ¶ï¼Œè¯·ä½¿ç”¨å³ä¾§æ‰‹åŠ¨å¯¼å…¥ï¼ˆå¤åˆ¶å®˜ç½‘è¡¨æ ¼ç²˜è´´å³å¯ï¼‰','err');
  }
}

async function importManual(){
  const nums=extractBids(document.getElementById('win-input').value);
  if(!nums.size){setMsg('manual-msg','âŒ æœªè¯†åˆ«åˆ°æŠ•æ ‡å·','err');return;}
  const arr=[...nums];
  winSet=nums;
  await dbSet('winlist',arr);
  await dbSet('winmonth',nowMonth());
  setSyncDot('ok',`åå•å·²å°±ç»ª ${arr.length.toLocaleString()} æ¡`);
  setMsg('manual-msg',`âœ… å¯¼å…¥æˆåŠŸï¼š${arr.length.toLocaleString()} æ¡ï¼Œå·²åŒæ­¥äº‘ç«¯`,'ok');
  document.getElementById('win-input').value='';
  updateListStatus();
}

// â”€â”€ IMAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingImgs=[];
function loadImgs(input){
  const files=Array.from(input.files);
  if(!files.length)return;
  pendingImgs=files.map(f=>{
    const base=f.name.replace(/\.[^.]+$/,'');
    const m=base.match(/\b(5\d{7})\b/);
    return{file:f,bid:m?m[1]:'',preview:URL.createObjectURL(f)};
  });
  document.getElementById('pending-cnt').textContent=files.length;
  renderPairs();
  document.getElementById('pair-area').style.display='block';
}
function renderPairs(){
  const el=document.getElementById('pair-list');
  el.innerHTML=pendingImgs.map((p,i)=>`
    <div class="pair-item">
      <img class="pair-thumb" src="${p.preview}">
      <div style="flex:1;min-width:0">
        <div style="font-size:9px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:4px" title="${p.file.name}">${p.file.name}</div>
        <input class="pair-input" value="${p.bid}" placeholder="æŠ•æ ‡å·" onchange="pendingImgs[${i}].bid=this.value.trim()">
      </div>
    </div>`).join('');
}
async function saveImgs(){
  const valid=pendingImgs.filter(p=>p.bid);
  if(!valid.length){setMsg('img-msg','è¯·å¡«å†™æŠ•æ ‡å·','err');return;}
  setMsg('img-msg','ä¸Šä¼ ä¸­...','info');
  const newIdx={...imgIndex};
  let done=0;
  for(const p of valid){
    const path=`evidence/${p.bid}.jpg`;
    const {error}=await sb.storage.from('evidence').upload(path,p.file,{upsert:true,contentType:p.file.type});
    if(!error){newIdx[p.bid]=path;done++;}
  }
  imgIndex=newIdx;
  await dbSet('imgindex',imgIndex);
  setMsg('img-msg',`âœ… å·²ä¸Šä¼  ${done} å¼ æˆªå›¾åˆ°äº‘ç«¯ï¼Œæ‰€æœ‰è®¾å¤‡åŒæ­¥`,'ok');
  document.getElementById('img-cnt').textContent=Object.keys(imgIndex).length;
  updateImgStatus();
  pendingImgs=[];
  document.getElementById('pair-area').style.display='none';
}

// â”€â”€ QUERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doQuery(){
  if(!winSet.size){alert('è¯·å…ˆåŒæ­¥æˆ–å¯¼å…¥æœ¬æœˆæˆäº¤åå•');return;}
  const lines=document.getElementById('q-input').value.split('\n').map(l=>l.trim()).filter(Boolean);
  const items=lines.map(line=>{
    const m=line.match(/\b(5\d{7})\b/);if(!m)return null;
    const bid=m[1],name=line.replace(bid,'').replace(/[\s\t,ï¼Œ]+/g,'').trim();
    return{name:name||null,bid};
  }).filter(Boolean);
  if(!items.length){alert('è¯·è¾“å…¥æŠ•æ ‡å·');return;}
  const won=[],lost=[];
  items.forEach(it=>(winSet.has(it.bid)?won:lost).push(it));
  const rate=items.length?Math.round(won.length/items.length*100):0;
  const html=`<div class="panel">
    <div class="r-stats">
      <div class="r-card" style="background:rgba(122,179,240,.07);border:1px solid rgba(122,179,240,.15)"><div class="r-v" style="color:#7ab3f0">${items.length}</div><div class="r-l">æŸ¥è¯¢æ€»æ•°</div></div>
      <div class="r-card" style="background:rgba(0,229,122,.07);border:1px solid rgba(0,229,122,.15)"><div class="r-v" style="color:var(--green);text-shadow:0 0 16px rgba(0,229,122,.5)">${won.length}</div><div class="r-l">ğŸ‰ ä¸­æ ‡æ•°</div></div>
      <div class="r-card" style="background:rgba(245,200,66,.07);border:1px solid rgba(245,200,66,.15)"><div class="r-v" style="color:var(--gold)">${rate}%</div><div class="r-l">ğŸ“Š ä¸­æ ‡ç‡</div></div>
    </div>
    ${won.length?`<div style="font-size:10px;color:var(--green);font-weight:700;letter-spacing:1px;margin-bottom:10px">ğŸ‰ ä¸­æ ‡åå• <span style="color:var(--muted);font-weight:400">Â· ç‚¹å‡»æ ‡ç­¾æŸ¥çœ‹å‡­è¯æˆªå›¾</span></div>
    <div class="tags">${won.map(it=>`<div class="tag${imgIndex[it.bid]?' has-img':''}" onclick='openModal(${JSON.stringify(it)})'>${it.name?`<span class="tw-name">${it.name}</span>`:''}<span class="tw-num">${it.bid}</span>${imgIndex[it.bid]?'<span style="font-size:9px">ğŸ“·</span>':''}</div>`).join('')}</div>`
    :'<div style="text-align:center;padding:24px 0;color:var(--muted);font-size:12px">æœ¬æœŸæŸ¥è¯¢å·ç å‡æœªä¸­æ ‡ï¼Œä¸‹æœŸç»§ç»­åŠ æ²¹ ğŸ’ª</div>'}
  </div>`;
  document.getElementById('q-result').innerHTML=html;
}
function clearQ(){document.getElementById('q-input').value='';document.getElementById('q-result').innerHTML='<div class="panel empty-hint"><div style="font-size:36px;opacity:.2">ğŸ”</div><div style="font-size:12px">åœ¨å·¦ä¾§è¾“å…¥æŠ•æ ‡å·åç‚¹å‡»æŸ¥è¯¢</div></div>';}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openModal(item){
  document.getElementById('m-name').textContent=item.name||'â€”';
  document.getElementById('m-bid').textContent='æŠ•æ ‡å· '+item.bid;
  const wrap=document.getElementById('m-evidence');
  if(imgIndex[item.bid]){
    const {data}=await sb.storage.from('evidence').createSignedUrl(imgIndex[item.bid],3600);
    wrap.innerHTML=data?`<img class="evidence-img" src="${data.signedUrl}">`:`<div class="no-evidence"><div style="font-size:24px;opacity:.3">ğŸ“·</div>åŠ è½½å¤±è´¥</div>`;
  }else{
    wrap.innerHTML=`<div class="no-evidence"><div style="font-size:24px;margin-bottom:8px;opacity:.3">ğŸ“·</div>æš‚æ— æˆªå›¾<br><span style="font-size:10px">ä¸Šä¼ å‘½åä¸ºã€Œ${item.bid}.jpgã€çš„æˆªå›¾å³å¯è‡ªåŠ¨åŒ¹é…</span></div>`;
  }
  document.getElementById('modal').classList.add('on');
}

// â”€â”€ LIVE LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let logPrice=94400,logId=0;
const RLOG=[{n:'é—µè¡Œæœºæˆ¿',c:'#00d4ff'},{n:'å˜‰å®šæœºæˆ¿',c:'#00e57a'},{n:'æ¾æ±Ÿæœºæˆ¿',c:'#f5c842'}];
const ALOG=[{l:'æäº¤',c:'#00e57a'},{l:'éªŒè¯',c:'#00d4ff'},{l:'å‡ºä»·',c:'#f5c842'},{l:'ç¡®è®¤',c:'#00e57a'}];
function logStart(){
  setInterval(()=>{
    const r=RLOG[Math.floor(Math.random()*3)],a=ALOG[Math.floor(Math.random()*4)];
    const dev=Math.floor(Math.random()*99)+1;
    if(Math.random()>.7)logPrice=Math.max(80000,logPrice+100);
    const delta=(Math.floor(Math.random()*3)-1)*100;
    const n=new Date(),p=x=>String(x).padStart(2,'0');
    const t=`${p(n.getHours())}:${p(n.getMinutes())}:${p(n.getSeconds())}`;
    const row=document.createElement('div');row.className='log-row';
    row.innerHTML=`<span class="log-t">${t}</span><span class="log-room" style="color:${r.c}">${r.n}</span><span class="log-dev">è®¾å¤‡${String(dev).padStart(2,'0')}</span><span class="log-action" style="color:${a.c}">${a.l}</span><span class="log-price">Â¥${logPrice.toLocaleString()}</span><span class="log-delta" style="color:${delta>0?'#00e57a':delta<0?'#ff4060':'transparent'}">${delta!==0?(delta>0?'+':'')+delta:''}</span>`;
    const body=document.getElementById('log-body');
    body.insertBefore(row,body.firstChild);
    if(body.children.length>40)body.removeChild(body.lastChild);
  },800+Math.random()*500);
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function go(name,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('page-'+name).classList.add('on');
  el.classList.add('on');
}
function extractBids(t){const s=new Set();(t.match(/\b5\d{7}\b/g)||[]).forEach(n=>s.add(n));return s;}
function nowMonth(){const d=new Date();return`${d.getFullYear()}-${d.getMonth()+1}`;}
function setText(id,val){const e=document.getElementById(id);if(e)e.textContent=val;}
function setSyncDot(type,text){
  const d=document.getElementById('sync-dot'),t=document.getElementById('sync-text');
  d.className='dot dot-'+type;
  t.textContent=text;t.style.color=type==='ok'?'var(--green)':type==='warn'?'var(--gold)':'var(--red)';
}
function setPb(id,pct){const e=document.getElementById(id);if(e)e.style.width=pct+'%';}
function setMsg(id,text,type){const e=document.getElementById(id);if(!e)return;e.textContent=text;e.className='msg '+type;}
function updateListStatus(){
  const e=document.getElementById('qs-list');
  if(e){e.textContent=winSet.size?`âœ“ ${winSet.size.toLocaleString()} æ¡`:'æœªåŠ è½½';e.style.color=winSet.size?'var(--green)':'var(--muted)';}
}
function updateImgStatus(){
  const cnt=Object.keys(imgIndex).length;
  const e=document.getElementById('qs-img');
  if(e){e.textContent=cnt?`${cnt} å¼ `:'æœªåŠ è½½';e.style.color=cnt?'var(--green)':'var(--muted)';}
  document.getElementById('img-cnt').textContent=cnt;
}

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âš ï¸ åœ¨è¿™é‡Œä¿®æ”¹å¯†ç ï¼Œæ”¹å®Œé‡æ–°ä¸Šä¼  GitHub å³å¯
const PASSWORDS = ['xdpai2026', 'xiaodong888'];  // å¯ä»¥è®¾å¤šä¸ªï¼Œå‘˜å·¥ç”¨ä¸åŒå¯†ç 

function doLogin(){
  const pw = document.getElementById('pw-input').value.trim();
  const err = document.getElementById('login-err');
  if(!pw){ err.textContent='è¯·è¾“å…¥å¯†ç '; return; }
  if(PASSWORDS.includes(pw)){
    // è®°ä½ç™»å½•çŠ¶æ€ï¼ˆå…³é—­æ ‡ç­¾é¡µåå¤±æ•ˆï¼Œé‡å¼€éœ€é‡æ–°è¾“å…¥ï¼‰
    sessionStorage.setItem('xd_auth', btoa(pw));
    document.getElementById('login-screen').style.display='none';
    document.getElementById('loading').style.display='flex';
    initApp();
  } else {
    err.textContent='å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
    document.getElementById('pw-input').value='';
    document.getElementById('pw-input').focus();
    // æŠ–åŠ¨æ•ˆæœ
    const box = document.querySelector('.login-box');
    box.style.animation='none';
    box.style.transform='translateX(-8px)';
    setTimeout(()=>{ box.style.transform='translateX(8px)'; }, 80);
    setTimeout(()=>{ box.style.transform=''; }, 160);
  }
}

function togglePw(){
  const inp = document.getElementById('pw-input');
  inp.type = inp.type==='password' ? 'text' : 'password';
}

// æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆåŒä¸€ä¸ªæ ‡ç­¾é¡µå†…åˆ·æ–°ä¸ç”¨é‡æ–°è¾“å…¥ï¼‰
function checkAuth(){
  const auth = sessionStorage.getItem('xd_auth');
  if(auth && PASSWORDS.includes(atob(auth))){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('loading').style.display='flex';
    initApp();
  } else {
    // æ˜¾ç¤ºç™»å½•æ¡†ï¼Œèšç„¦è¾“å…¥
    setTimeout(()=>{ const e=document.getElementById('pw-input'); if(e)e.focus(); }, 100);
  }
}

async function initApp(){
  clockStart();
  logStart();
  await Promise.all([loadStats(), loadWinList(), loadImgIndex()]);
  document.getElementById('loading').style.display='none';
  setSyncDot('ok','äº‘ç«¯å·²è¿æ¥');
}
</script>
</body>
</html>
